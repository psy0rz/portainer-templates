#NOTE: expects 8Gb of ram.
#set vm.max_map_count=1024000 in /etc/sysctl.conf
#(dont forget to enable sysctl service to boot)

# traefik:80 --> varnish:80 ->  nginx:8080 -> fpm:9000

services:

  db:
    image: mariadb:${MARIADB_VERSION}
    environment:
      - MARIADB_USER=magento
      - MARIADB_PASSWORD=magento
      - MARIADB_DATABASE=magento
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}

    volumes:
      - db:/var/lib/mysql
    restart: unless-stopped

    ports:
     - 127.0.0.1:${MYSQL_PORT}:3306


    stop_grace_period: 10s

  web:
    image: magento/magento-cloud-docker-nginx:${NGINX_VERSION}
      
    volumes:
      - app:/app

    ports:
     - 127.0.0.1:${HTTP_PORT}:8080
    
    
    environment:
     - MAGEMAGE_RUN_CODE=base

    labels:
      - traefik.enable=true
    
      
      #https
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-https.entrypoints=websecure
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-https.rule=${TRAEFIK_RULE}
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-https.tls.certresolver=myzerossl 
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-https.tls=true
      - traefik.http.services.${COMPOSE_PROJECT_NAME}.loadbalancer.server.port=8080

    networks:
      - proxynet
      - default

    restart: unless-stopped
    stop_grace_period: 0s

  fpm:
    image: magento/magento-cloud-docker-php:${FPM_VERSION}

    environment:
     - MAGEMAGE_RUN_CODE=base

    volumes:
     - app:/app

    restart: unless-stopped
    stop_grace_period: 0s
    command: php-fpm

  cron:
    image: magento/magento-cloud-docker-php:${CLI_VERSION}

    volumes:
     - app:/app

    restart: unless-stopped
    environment:
      - CRONTAB=* * * * * www /usr/local/bin/php /app/bin/magento cron:run
    command: cron -f

    stop_grace_period: 0s

  opensearch:
    image: magento/magento-cloud-docker-opensearch:2.12-1.4.0
    environment:
    #  - OPENSEARCH_INITIAL_ADMIN_PASSWORD=NkMUJR*w&9w3m7
     - cluster.name=opensearch-cluster # Name the cluster
     - node.name=node1 # Name the node that will run in this container
    #  - discovery.seed_hosts=node1
     - cluster.initial_cluster_manager_nodes=node1
    #  - bootstrap.memory_lock=true # Disable JVM heap memory swapping
    #  - OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx3500m # Set min and max JVM heap sizes to at least 50% of system RAM
     - DISABLE_INSTALL_DEMO_CONFIG=true
     - DISABLE_SECURITY_PLUGIN=true
    restart: unless-stopped


  smtp:
    image: mwader/postfix-relay
    environment: 
      - POSTFIX_myhostname=${POSTFIX_HOSTNAME}

    restart: unless-stopped
    stop_grace_period: 0s


  ssh:
    hostname: ${COMPOSE_PROJECT_NAME}
    build:
      context: ./build/ssh
      args:
        - CLI_VERSION=${CLI_VERSION}
    environment:
       - SSH_KEY=${SSH_KEY}
    ports:
      - ${SSH_PORT}:22
    volumes:
     - app:/app
    restart: unless-stopped
    stop_grace_period: 0s

networks:
  proxynet:
    name: proxynet

volumes:
  db:
    # driver: zfs
  app:
    # driver: zfs
